#!/bin/bash -e

GORELEASER_ARGS='--rm-dist --skip-validate'
if [ "$CI_COMMIT_REF_NAME" != "master" ]; then
  GORELEASER_ARGS="$GORELEASER_ARGS --snapshot"
fi

git fetch --tags  # jenkins does not do this automatically yet

docker-compose pull goreleaser

echo "> Building and packaging binaries"
docker-compose run --rm -T --entrypoint sh goreleaser -es <<EOF
go mod download
goreleaser release $GORELEASER_ARGS
EOF

bin_name='dev-flow'
goos='linux'  # uname -s | tr '[:upper:]' '[:lower:]'
goarch="amd64"

cp "dist/${goos}_${goarch}/${bin_name}" .  # for following test stages
